<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <!-- Bootstrap Icons -->
  <link rel="stylesheet" href="https://cdn-uicons.flaticon.com/uicons-regular-rounded/css/uicons-regular-rounded.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
  <!-- Google Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@700&display=swap" rel="stylesheet">
  <!-- style sheets -->
  <link rel="stylesheet" th:href="@{/stylesheet/style.css}">
  <link rel="stylesheet" th:href="@{/stylesheet/product_style.css}">
  <title>Room-Selection</title>
  <!-- Pass current user data to JavaScript -->
  <meta name="current-user-id" th:content="${currentUser?.id}" th:if="${currentUser}">
  <meta name="current-user-email" th:content="${currentUser?.email}" th:if="${currentUser}">
  <meta name="current-user-name" th:content="${currentUser?.name}" th:if="${currentUser}">

</head>
<body class="product">

<!-- Debug Panel (only show in development) -->
<div class="debug-panel" th:if="${@environment.acceptsProfiles('dev')}">
  <div class="debug-header">
    <strong>Payment Debug</strong>
    <span class="debug-toggle" onclick="toggleDebug()">Hide</span>
  </div>
  <div class="debug-content" id="debugContent">
    <div class="debug-log debug-info">Debug panel initialized</div>
  </div>
</div>

<!-- Processing Modal -->
<div class="modal fade" id="processingModal" tabindex="-1" aria-hidden="true" data-bs-backdrop="static" data-bs-keyboard="false">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-body text-center py-5">
        <div class="processing-spinner"></div>
        <h4 class="mb-3">Processing Payment...</h4>
        <p class="text-muted">Please wait while we redirect you to the payment gateway.</p>
      </div>
    </div>
  </div>
</div>

<!-- Success Modal -->
<div class="modal success-modal fade" id="successModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-body text-center py-5">
        <div class="success-icon">
          <i class="bi bi-check-circle-fill"></i>
        </div>
        <h3 class="mb-3">Payment Successful!</h3>
        <p class="text-muted">Your application is pending approval from administrators. You will be notified once it's reviewed.</p>
        <button type="button" class="btn btn-blue-gradient mt-3" data-bs-dismiss="modal">Continue</button>
      </div>
    </div>
  </div>
</div>

<!-- Error Modal -->
<div class="modal fade" id="errorModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-body text-center py-5">
        <div class="text-danger" style="font-size: 5rem;">
          <i class="bi bi-x-circle-fill"></i>
        </div>
        <h3 class="mb-3">Payment Failed</h3>
        <p class="text-muted" id="errorMessage">An error occurred during payment processing.</p>
        <button type="button" class="btn btn-secondary mt-3" data-bs-dismiss="modal">Try Again</button>
      </div>
    </div>
  </div>
</div>

<!-- Import header fragment -->
<div th:replace="~{headerfragment :: siteHeader}"></div>

<section class="product-list container mt-3">

  <!-- Also handle URL parameters for backward compatibility -->
  <div th:if="${param.success}" class="alert alert-success alert-dismissible fade show" role="alert">
    <i class="bi bi-check-circle-fill me-2"></i>
    Payment successful! Your application is pending approval.
    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
  </div>
  
  <div th:if="${param.error}" class="alert alert-danger alert-dismissible fade show" role="alert">
    <i class="bi bi-exclamation-circle-fill me-2"></i>
    <span th:text="${param.error}">An error occurred</span>
    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
  </div>

  <p class="text-product-list text-muted small mb-4">
    Get started on your accommodation process, select a home that works for you
  </p>

  <div class="row row-cols-1 row-cols-md-2 row-cols-lg-4 g-4">
    <!-- Loop over rooms -->
    <div class="col" th:each="room : ${rooms}">
      <div class="card h-100 shadow-sm">
        <div class="card-img-container position-relative overflow-hidden">
          <img th:src="${room.house.imageUrl}" 
              class="card-img-top" 
              alt="Property image"
              loading="lazy"
              onerror="this.src='/images/placeholder.jpg'">
          <!-- Price overlay that appears on hover -->
          <div class="price-overlay">
            <p class="price-text" th:text="'₦' + ${#numbers.formatDecimal(room.rent, 0, 'COMMA', 0, 'POINT')}">₦0</p>
            <small>per semester</small>
          </div>
        </div>
        <div class="card-body d-flex flex-column">
          <h5 class="card-title" 
              th:text="${room.house.name} + ' - Room ' + ${room.roomNo}">
              HouseName - Room X
          </h5>
          <p class="card-text flex-grow-1" th:text="${room.house.description}">
            Description here
          </p>
          <div class="mt-auto">
            <a href="#"
              class="btn text-white btn-blue-gradient w-100 view-details-btn"
              data-bs-toggle="modal" 
              data-bs-target="#propertyModal"
              th:attr="data-roomid=${room.id},
                        data-title=${room.house.name} + ' - Room ' + ${room.roomNo},
                        data-description=${room.house.description},
                        data-bath=${room.bath},
                        data-rooms=${room.numberOfRoom},
                        data-floor=${room.floorNo},
                        data-location=${room.house.location},
                        data-price=${room.rent},
                        data-image=${room.house.imageUrl}">
              <i class="bi bi-eye me-2"></i>View Details
            </a>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Property Details Modal -->
  <div class="modal fade" id="propertyModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered">
      <div class="modal-content border-0">
        <div class="modal-body p-4">
          <div class="row g-4"> 
            <div class="col-md-6">
              <img id="modalImage" class="img-fluid rounded" alt="Property image">
            </div>

            <div class="col-md-6">
              <h4 id="modalTitle" class="mb-3"></h4>
              
              <!-- Enhanced info badges -->
              <div class="mb-3">
                <span class="info-badge">
                  <i class="bi bi-bucket-fill"></i> <span id="modalBath"></span>
                </span>
                <span class="info-badge">
                  <i class="bi bi-bed-fill"></i> <span id="modalRoom"></span>
                </span>
                <span class="info-badge">
                  <i class="bi bi-building-fill"></i> <span id="modalFloor"></span>
                </span>
              </div>
              
              <!-- Location with enhanced styling -->
              <div class="location-badge mb-3">
                <i class="bi bi-geo-alt-fill me-2"></i> <span id="modalAddress"></span>
              </div>
              
              <h6 class="text-primary">Description</h6>
              <p id="modalDescription" class="text-muted mb-4"></p>
              
              <div class="d-flex justify-content-between align-items-center mt-3">
                <h5 class="text-primary mb-0" id="modalPrice"></h5>
                <div class="text-end">
                  <div class="text-muted small mb-2" id="currentUserDisplay" style="display: none;">
                    <i class="bi bi-person-fill"></i> <span id="currentUserText"></span>
                  </div>
                  <button type="button" class="btn btn-blue-gradient text-white px-4" id="applyButton">
                    <i class="bi bi-credit-card me-2"></i>Apply Now
                  </button>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</section> 

<!-- Hidden form for server communication -->
<form id="paymentForm" class="hidden" method="post">
  <input type="hidden" name="userEmail" id="userEmailInput">
</form>

<script th:src="@{/javascript/modal-handler.js}"></script>
<script th:src="@{/javascript/payment-handler.js}"></script>
<script th:src="@{/javascript/user-handling.js}"></script>
<script th:src="@{/javascript/utility-functions.js}"></script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.7/dist/js/bootstrap.bundle.min.js"></script>
    
</body>
</html>